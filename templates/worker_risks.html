{% extends "base.html" %}

{% block title %}Оценка рисков: {{ worker.position }}{% endblock %}

{% block content %}

<h1>Оценка рисков: {{ worker.position }}</h1>

<div class="info">
    Заполните оценки для каждого риска.<br>
    Степень = 0 → риск пропускается.
</div>

<form method="post" action="/save_worker_risks/{{ job_id }}/{{ worker_idx }}">

    {% for danger in dangers %}
    <h2 style="margin-top: 2em;">{{ danger.danger_number }}. {{ danger.danger_name }}</h2>

    {% for risk in danger.risks %}
    <div style="margin: 1.8em 0; padding: 1.2em; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
        <strong style="font-size: 1.15em;">{{ risk.risk_number }}. {{ risk.risk_name }}</strong>

        <div style="margin-top: 1.2em; display: flex; flex-wrap: wrap; gap: 2em; font-size: 1.1em;">
            <label style="flex: 1; min-width: 220px;">
                Степень травмирования:
                <select name="deg__{{ danger.danger_number }}__{{ risk.risk_number }}"
                        style="font-size: 1.15em; padding: 0.6em 1em; width: 100%; margin-top: 0.4em;">
                    {% for i in range(0, 6) %}
                    <option value="{{ i }}"
                            title="{{ degree_info.get(i, 'Пропустить') }}"
                            {% if existing.get(danger.danger_number, {}).get(risk.risk_number, {}).get('deg') == i %}selected{% endif %}>
                        {{ i }}
                    </option>
                    {% endfor %}
                </select>
            </label>

            <label style="flex: 1; min-width: 220px;">
                Вероятность:
                <select name="ch__{{ danger.danger_number }}__{{ risk.risk_number }}"
                        style="font-size: 1.15em; padding: 0.6em 1em; width: 100%; margin-top: 0.4em;">
                    {% for i in range(1, 6) %}
                    <option value="{{ i }}"
                            title="{{ chance_info.get(i, '') }}"
                            {% if existing.get(danger.danger_number, {}).get(risk.risk_number, {}).get('ch', 1) == i %}selected{% endif %}>
                        {{ i }}
                    </option>
                    {% endfor %}
                </select>
            </label>

            <label style="flex: 1; min-width: 220px;">
                Коэффициент:
                <select name="kef__{{ danger.danger_number }}__{{ risk.risk_number }}"
                        style="font-size: 1.15em; padding: 0.6em 1em; width: 100%; margin-top: 0.4em;">
                    {% set opts = [0.1, 0.3, 0.5, 0.7, 0.9] %}
                    {% for k in opts %}
                    <option value="{{ k }}"
                            title="{{ coeff_info.get(k, '') }}"
                            {% if existing.get(danger.danger_number, {}).get(risk.risk_number, {}).get('kef', 0.1) == k %}selected{% endif %}>
                        {{ k }}
                    </option>
                    {% endfor %}
                </select>
            </label>
        </div>
    </div>
    {% endfor %}
    {% endfor %}

    <div style="margin-top: 2.5em; display: flex; gap: 1.5em; flex-wrap: wrap;">
        <button type="submit" class="btn" style="font-size: 1.2em; padding: 0.9em 2em;">
            Сохранить и перейти дальше →
        </button>

        {% if worker_idx > 0 %}
        <a href="/worker_risks/{{ job_id }}/{{ worker_idx - 1 }}"
           class="btn" style="background: #7f8c8d; font-size: 1.1em; padding: 0.8em 1.8em;">
            ← Назад
        </a>
        {% endif %}

        <a href="/" class="btn" style="background: #95a5a6; font-size: 1.1em; padding: 0.8em 1.8em;">
            ← Вернуться к выбору опасностей
        </a>
    </div>
</form>

{% endblock %}