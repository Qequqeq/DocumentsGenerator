{% extends "base.html" %}

{% block title %}Создание шаблона должности{% endblock %}

{% block content %}
<h1>Создание шаблона должности</h1>

<div class="info">
    Заполните оценки для каждого риска. После сохранения будет скачан JSON-файл.
</div>

<form method="post" action="/create-template">
    <p>
        <label for="template_name">Название должности:</label><br>
        <input type="text" id="template_name" name="template_name" required
               style="width: 300px; padding: 8px; font-size: 1.1em;">
    </p>

    {% for danger in dangers %}
    <h2 style="margin-top: 2em;">{{ danger.danger_number }}. {{ danger.danger_name }}
    </h2>
    <div style="margin-left: 0.5em; margin-bottom: 0.5em; font-size: 1.1em; color: #2c3e50;">
        Суммарный риск по всем опасностям: <span class="total-risk-display">0.00</span>
    </div>
    <div style="margin-left: 0.5em; margin-bottom: 0.5em; font-size: 1.1em; color: #2c3e50;">
        Риск по данной опасности: <span id="danger-risk-{{ danger.danger_number|replace('.', '_') }}">0.00</span>
    </div>

    {% for risk in danger.risks %}
    <div style="margin: 1.8em 0; padding: 1.2em; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
        <strong style="font-size: 1.15em;">{{ risk.risk_number }}. {{ risk.risk_name }}</strong>

        <div style="margin-top: 1.2em; display: flex; flex-wrap: wrap; gap: 2em; font-size: 1.1em;">
            <label style="flex: 1 0 190px; min-width: 190px;">
                Степень травм.:
                <select name="deg__{{ danger.danger_number }}__{{ risk.risk_number }}"
                        style="font-size: 1.15em; padding: 0.6em 1em; width: 100%; margin-top: 0.4em;">
                    {% for i in range(1, 6) %}
                    <option value="{{ i }}"
                            title="{{ degree_info.get(i, 'Пропустить') }}"
                            {% if existing.get(danger.danger_number, {}).get(risk.risk_number, {}).get('deg') == i %}selected{% endif %}>
                        {{ i }}
                    </option>
                    {% endfor %}
                </select>
            </label>

            <label style="flex: 1 0 190px; min-width: 190px;">
                Вероятность:
                <select name="ch__{{ danger.danger_number }}__{{ risk.risk_number }}"
                        style="font-size: 1.15em; padding: 0.6em 1em; width: 100%; margin-top: 0.4em;">
                    {% for i in range(1, 6) %}
                    <option value="{{ i }}"
                            title="{{ chance_info.get(i, '') }}"
                            {% if existing.get(danger.danger_number, {}).get(risk.risk_number, {}).get('ch', 1) == i %}selected{% endif %}>
                        {{ i }}
                    </option>
                    {% endfor %}
                </select>
            </label>

            <label style="flex: 1 0 190px; min-width: 190px;">
                Коэффициент:
                <select name="kef__{{ danger.danger_number }}__{{ risk.risk_number }}"
                        style="font-size: 1.15em; padding: 0.6em 1em; width: 100%; margin-top: 0.4em;">
                    {% set opts = [0, 0.1, 0.3, 0.5, 0.7, 0.9] %}
                    {% for k in opts %}
                    <option value="{{ k }}"
                            title="{{ coeff_info.get(k, '') }}"
                            {% if existing.get(danger.danger_number, {}).get(risk.risk_number, {}).get('kef', 0) == k %}selected{% endif %}>
                        {{ k }}
                    </option>
                    {% endfor %}
                </select>
            </label>
            <div style="flex: 1 0 auto; min-width: 10px;">
                <span class="risk-product"
                            data-danger="{{ danger.danger_number }}"
                            data-risk="{{ risk.risk_number }}">0.0
                </span>
            </div>
        </div>
    </div>
    {% endfor %}
    {% endfor %}

        <div style="margin-top: 2.5em;">
        <button type="submit" class="btn" style="font-size: 1.2em; padding: 0.9em 2em;">
            Скачать шаблон
        </button>
        <a href="/" class="btn" style="background: #95a5a6; font-size: 1.1em; padding: 0.8em 1.8em; margin-left: 1em;">
            В главное меню
        </a>
    </div>
</form>
<script>
(function() {
    function computeRisks() {
        let dangerSums = {};
        let totalRisk = 0;

        const degSelects = document.querySelectorAll('select[name^="deg__"]');
        degSelects.forEach(degSelect => {
            const name = degSelect.name;
            const parts = name.split('__');
            if (parts.length !== 3) return;
            const dangerNum = parts[1];
            const riskNum = parts[2];

            const chSelect = document.querySelector(`select[name="ch__${dangerNum}__${riskNum}"]`);
            const kefSelect = document.querySelector(`select[name="kef__${dangerNum}__${riskNum}"]`);

            if (!chSelect || !kefSelect) return;

            const deg = parseFloat(degSelect.value);
            const ch = parseFloat(chSelect.value);
            const kef = parseFloat(kefSelect.value);

            if (isNaN(deg) || isNaN(ch) || isNaN(kef)) return;

            const risk = deg * ch * kef;

            const productSpan = document.querySelector(
                `.risk-product[data-danger="${dangerNum}"][data-risk="${riskNum}"]`
            );
            if (productSpan) {
                productSpan.textContent = risk.toFixed(1);
            }

            if (!dangerSums[dangerNum]) dangerSums[dangerNum] = 0;
            dangerSums[dangerNum] += risk;
            totalRisk += risk;
        });

        for (const [dangerNum, sum] of Object.entries(dangerSums)) {
            const safeDangerNum = dangerNum.replace(/\./g, '_');
            const span = document.getElementById(`danger-risk-${safeDangerNum}`);
            if (span) {
                span.textContent = sum.toFixed(1);
            }
        }

        const totalSpans = document.querySelectorAll('.total-risk-display');
        totalSpans.forEach(span => {
            span.textContent = totalRisk.toFixed(1);
        });
    }

    document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', computeRisks);
        select.addEventListener('input', computeRisks);
    });

    window.addEventListener('load', computeRisks);
})();
</script>
{% endblock %}