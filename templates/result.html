{% extends "base.html" %}

{% block title %}Результат генерации{% endblock %}

{% block content %}

<h1>Генерация карт</h1>

{% if error %}
    <div style="background: #ffebee; padding: 15px; border-left: 5px solid #c62828; margin: 20px 0;">
        <strong>Ошибка:</strong> {{ error }}
    </div>
{% endif %}

<div class="info">
    Обработано работников: <strong>{{ generated_count|default(0) }} из {{ total_workers|default(0) }}</strong>
</div>

{% if zip_ready %}
    <div style="margin: 40px 0; text-align: center;">
        <progress id="progress-success" value="100" max="100" style="width: 80%; height: 28px;"></progress>
        <p style="font-size: 1.4em; margin: 20px 0; color: #27ae60; font-weight: bold;">
            Готово! Карты сформированы и упакованы в архив.
        </p>
    </div>

    <div style="text-align: center; margin: 30px 0;">
        <a href="/download/{{ job_id }}" class="btn" id="downloadBtn" style="font-size: 1.4em; padding: 1em 2.5em;">
            Скачать ZIP-архив ({{ generated_count }} файлов)
        </a>
    </div>

    <div style="text-align: center; margin-top: 50px;">
        <button onclick="if(confirm('Закрыть приложение и остановить сервер?')) { window.close(); fetch('/shutdown', {method: 'POST'}); }"
                style="font-size: 1.6em; padding: 1.2em 3em; background: #c0392b; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            Завершить работу
        </button>
        <p style="margin-top: 12px; color: #7f8c8d; font-size: 1.1em;">
            (закроет вкладку и попытается остановить сервер)
        </p>
    </div>
{% else %}
    <div style="margin: 40px 0; text-align: center;">
        <progress id="progress-loading" value="0" max="100" style="width: 80%; height: 28px;"></progress>
        <p id="statusText" style="font-size: 1.4em; margin-top: 20px;">
            Генерация... (это может занять некоторое время)
        </p>
    </div>

    <p style="color: #555; text-align: center; font-size: 1.1em;">
        Пожалуйста подождите...
    </p>

    <script>
        let progress = 0;
        const bar = document.getElementById('progress-loading');
        const text = document.getElementById('statusText');

        {% if not zip_ready %}
        const interval = setInterval(() => {
            progress += Math.random() * 12 + 4;
            if (progress > 92) progress = 92;
            bar.value = progress;
            text.textContent = `Генерация... ${Math.round(progress)}%`;
        }, 1400);
        {% endif %}
    </script>
{% endif %}

{% if generated_count and generated_count > 0 %}
    <h3 style="margin-top: 50px;">Сгенерированные карты:</h3>
    <ul style="font-size: 1.15em; line-height: 1.6;">
        {% for worker in workers %}
            {% if worker.workerDangers %}
                <li>{{ worker.position }}</li>
            {% endif %}
        {% endfor %}
    </ul>
{% endif %}

{% endblock %}